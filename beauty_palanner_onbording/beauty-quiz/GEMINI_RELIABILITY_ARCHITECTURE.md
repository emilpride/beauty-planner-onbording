# ๐๏ธ Gemini Reliability - System Architecture

---

## ๐ High-Level Architecture

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                     FRONTEND (React/Next.js)                โ
โ                                                              โ
โ  POST /analyzeUserData โ { userId, answers, photoUrls }    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                             โ
                             โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ              CLOUD FUNCTION: analyzeUserData                 โ
โ                      (Timeout: 60s)                         โ
โ                                                              โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  โ PHASE 1: PRE-CHECK (5s)                                 โโ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโคโ
โ  โ โ Circuit breaker check                                 โโ
โ  โ โ Rate limiting (10 req/min per IP)                    โโ
โ  โ โ Input validation (age, height, weight)               โโ
โ  โ โ Cache key generation                                  โโ
โ  โ โ Check Firestore cache                                โโ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                             โผ                                โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  โ PHASE 2: AI ANALYSIS (45s max)                          โโ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโคโ
โ  โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  โ โ TRY 1: Gemini API                                    โโโ
โ  โ โ โโ Attempt 1: Retry (500ms delay)                   โโโ
โ  โ โ โโ Attempt 2: Retry (1s delay)                      โโโ
โ  โ โ โโ Attempt 3: Retry (2s delay)                      โโโ
โ  โ โ โโ Attempt 4: Retry (4s delay)                      โโโ
โ  โ โ โ All failed                                         โโโ
โ  โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  โ                      โผ                                   โโ
โ  โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  โ โ TRY 2: Claude API Fallback (if enabled)              โโโ
โ  โ โ โ Claude 3.5 Sonnet                                 โโโ
โ  โ โ โ Same format as Gemini output                       โโโ
โ  โ โ โ Failed or not enabled                              โโโ
โ  โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  โ                      โผ                                   โโ
โ  โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  โ โ FALLBACK: Error Response (graceful failure)          โโโ
โ  โ โ Status 502: "Service temporarily unavailable"        โโโ
โ  โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                             โผ                                โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  โ PHASE 3: POST-PROCESSING (10s)                          โโ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโคโ
โ  โ โ Build complete analysis                              โโ
โ  โ โ Save to Firestore (users/{userId}/analysis)         โโ
โ  โ โ Save to cache (ai_analysis_cache)                    โโ
โ  โ โ Log session events                                    โโ
โ  โ โ Record metrics                                        โโ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                             โผ                                โ
โ  Response: 200 OK { analysis, fromCache?, usedFallback? }   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                             โ
                             โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ            MONITORING & ANALYTICS (Background)              โ
โ                                                              โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ โ logAPIEvent()                                          โ โ
โ โ โ Firestore: api_events/{date}/events                โ โ
โ โ โ Events: success, failure, retry, cache_hit, etc    โ โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ                                                              โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ โ updateRealtimeMetrics()                                โ โ
โ โ โ Firestore: system/api_metrics                        โ โ
โ โ โ Fields: events, window, avgLatency, etc              โ โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ                                                              โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ โ sendSentryAlert()                                      โ โ
โ โ โ Sentry: Issue/Alerts dashboard                      โ โ
โ โ โ Alerts: retry_exhausted, circuit_open, etc          โ โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ Request Flow Diagram

```
START
  โ
[Circuit Breaker?] โโYESโ Return 503 โโโ END (Error)
  โ
 NO
  โ
[Rate Limited?] โโYESโ Return 429 โโโ END (Error)
  โ
 NO
  โ
[Input Valid?] โโNOโ Return 400 โโโ END (Error)
  โ
YES
  โ
[Cache Key Gen] โ Calculate similarity hash
  โ
[Check Cache] โโHITโ Return Cached Result โโโ END (200 OK)
  โ
 MISS
  โ
[Start Heartbeat] โ Log progress every 15s
  โ
[Try Gemini] โโโโ
      โ         โ
      โโโ Attempt 1 (500ms)
      โโโ Attempt 2 (1s)
      โโโ Attempt 3 (2s)
      โโโ Attempt 4 (4s)
      โ
      โโโSUCCESSโ Parse JSON โโ Validate Format โโYESโ [Save & Return]
      โ                                           โ
      โ                                           NOโ
      โ                                        [Try Claude]
      โโโFAILโ [Try Claude Fallback] โโSUCCESSโ [Save & Return]
               โ                       FAILโ
               โโโโโโโโโโโ Return 502 โโโ END (Error)

[Save & Return]
  โ
[Save to Firestore]
[Save to Cache]
[Log Session]
[Stop Heartbeat]
[Record Metrics]
[Send Success Event]
  โ
Return 200 OK + Analysis
  โ
END
```

---

## ๐๏ธ Data Flow Architecture

```
โโโโโโโโโโโโโโโโโโโโ
โ   FRONTEND       โ
โ  (React/Next)    โ
โโโโโโโโโโฌโโโโโโโโโโ
         โ
         โ POST /analyzeUserData
         โ { userId, answers, photos }
         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ    CLOUD FUNCTION: analyzeUserData       โ
โ  (Timeout: 60s, Max instances: 10)      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                          โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โ Circuit Breaker Check            โ   โ
โ  โ (in-memory + Firestore)          โ   โ
โ  โ State: { failures, isOpen, ... } โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                 โผ                        โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โ Input Validation                 โ   โ
โ  โ (age, height, weight, etc)       โ   โ
โ  โ โ Trim strings                   โ   โ
โ  โ โ Validate ranges               โ   โ
โ  โ โ Limit array sizes             โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                 โผ                        โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โ Cache Key Generation             โ   โ
โ  โ Key = Age:Gender:SkinType:...    โ   โ
โ  โ (Base64 encoded)                 โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                 โผ                        โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โ Firestore: ai_analysis_cache     โ   โ
โ  โ Check for existing analysis      โ   โ
โ  โ Cache HIT? โ Return cached       โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                 โผ                        โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โ Retry with Exponential Backoff   โ   โ
โ  โ retryWithBackoff(4 attempts)     โ   โ
โ  โ โโ 500ms                         โ   โ
โ  โ โโ 1s                            โ   โ
โ  โ โโ 2s                            โ   โ
โ  โ โโ 4s                            โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                 โผ                        โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โ Gemini API Call (45s timeout)    โ   โ
โ  โ https://generativelanguage...    โ   โ
โ  โ โโ User profile + photos         โ   โ
โ  โ โโ Strict JSON schema            โ   โ
โ  โ โโ Procedure ID validation       โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                 โ                        โ
โ    โโโโโโโโโโโโโโดโโโโโโโโโโโ             โ
โ    โผ FAIL (after 4 tries)  โผ SUCCESS     โ
โ  โโโโโโโโโโโโโโโโโโโโโโโ  [Parse JSON]   โ
โ  โ Claude Fallback     โ  [Validate]     โ
โ  โ (if enabled)        โ  [Build Analysis]โ
โ  โ                     โ  โโโโโโโโฌโโโโโโโโโ
โ  โ API: Claude 3.5     โ         โผ
โ  โ Key: $CLAUDE_KEY    โ  โโโโโโโโโโโโโโโโ
โ  โ (45s timeout)       โ  โ Save Results โ
โ  โ                     โ  โโโโโโโโโโโโโโโโค
โ  โ SUCCESS? โโYESโโโฌโโโโค  โ Firestore:   โ
โ  โ        โโNOโโ  โ   โ  โ users/{uid}/ โ
โ  โ            โผ  โผ   โ  โ analysis/    โ
โ  โ       Return 502   โ  โ โโ model     โ
โ  โ       Error        โ  โ โโ timestamp โ
โ  โ                    โ  โ โโ usedflag  โ
โ  โโโโโโโโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ
โ                                 โผ
โ                          โโโโโโโโโโโโโโโโ
โ                          โ Save to Cacheโ
โ                          โ Firestore:   โ
โ                          โ analysis_    โ
โ                          โ cache/{key}  โ
โ                          โ โโ analysis  โ
โ                          โ โโ createdAt โ
โ                          โ โโ TTL: 7d   โ
โ                          โโโโโโโโโโโโโโโโ
โ                                 โผ
โ                          โโโโโโโโโโโโโโโโ
โ                          โ Log Events   โ
โ                          โ Firestore:   โ
โ                          โ api_events/  โ
โ                          โ {date}/eventsโ
โ                          โโโโโโโโโโโโโโโโ
โ                                 โผ
โ                          โโโโโโโโโโโโโโโโ
โ                          โ Send Metrics โ
โ                          โ system/      โ
โ                          โ api_metrics  โ
โ                          โ โโ events    โ
โ                          โ โโ latency   โ
โ                          โ โโ status    โ
โ                          โโโโโโโโโโโโโโโโ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
         โ
         โ 200 OK + Analysis
         โ
         โผ
    FRONTEND
    (Display Results)
```

---

## ๐ Circuit Breaker State Machine

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ         CIRCUIT CLOSED              โ
โ (Normal Operation)                  โ
โ                                     โ
โ - Requests flow normally            โ
โ - Track success/failure rate        โ
โ - Count: failures/total ratio       โ
โโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโ
                 โ
    Failure Rate > 30% in 5 min?
                 โ
              YESโ
                 โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ         CIRCUIT OPEN                โ
โ (Failure Detected)                  โ
โ                                     โ
โ - Return 503 to all requests        โ
โ - Stop calling Gemini API           โ
โ - Wait for recovery timeout         โ
โ - Record time: lastFailureTime      โ
โ                                     โ
โ Triggers:                           โ
โ โโ sendSentryAlert('error')        โ
โ โโ Log: CIRCUIT BREAKER OPENED     โ
โ โโ Database: circuitBreakerOpen=T  โ
โโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโ
                 โ
    Wait 2 minutes for recovery
                 โ
              YESโ
                 โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ      CIRCUIT RECOVERING             โ
โ (Attempting to Resume)              โ
โ                                     โ
โ - Start allowing requests again     โ
โ - Try 1-2 requests to test API      โ
โ - If success: go CLOSED             โ
โ - If failure: stay OPEN (restart)   โ
โโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโ
                 โ
      Recovery succeeds?
                 โ
              YESโ
                 โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ         CIRCUIT CLOSED              โ
โ (Back to Normal)                    โ
โ - Continue normal operation         โ
โ - Reset failure counters            โ
โ - Log: CIRCUIT BREAKER CLOSED       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ Metrics Collection Architecture

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ   Cloud Function: analyzeUserData    โ
โ   (Every request)                    โ
โโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโ
                 โ
                 โ Calls: logAPIEvent()
                 โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ   Firestore Collection: api_events   โ
โ   Partitioned by date: /{date}/      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                      โ
โ Document structure:                  โ
โ {                                    โ
โ   type: 'success' | 'failure' |...  โ
โ   userId: 'user123'                 โ
โ   latencyMs: 12345                  โ
โ   attemptNumber: 2                  โ
โ   recordedAt: timestamp             โ
โ }                                    โ
โ                                      โ
โ Examples:                            โ
โ - { type: 'success', latencyMs: 8234โ
โ - { type: 'retry', attemptNumber: 2 โ
โ - { type: 'cache_hit', latencyMs:245โ
โ - { type: 'claude_fallback' }        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
         โ
         โ Aggregated to:
         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Firestore Document: system/metrics  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                      โ
โ {                                    โ
โ   events: {                          โ
โ     total: 1250                      โ
โ     success: 1220                    โ
โ     failure: 30                      โ
โ     retry: 85                        โ
โ     circuit_open: 0                  โ
โ     cache_hit: 320                   โ
โ     cache_miss: 512                  โ
โ     claude_fallback: 8               โ
โ   },                                 โ
โ   window: {                          โ
โ     success: 45                      โ
โ     failures: 5                      โ
โ     timestamp: 1728555600000         โ
โ   },                                 โ
โ   avgLatency: 12450                  โ
โ   circuitBreakerOpen: false          โ
โ   lastUpdated: timestamp             โ
โ }                                    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
         โ
         โ Read by:
         โโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโ
         โผ                โผ              โผ
    โโโโโโโโโโ      โโโโโโโโโโโโ  โโโโโโโโโโโโ
    โ Sentry โ      โDashboard โ  โAnalytics โ
    โAlerts  โ      โgetMetricsโ  โ Frontend โ
    โโโโโโโโโโ      โโโโโโโโโโโโ  โโโโโโโโโโโโ
```

---

## ๐ Module Dependencies

```
index.ts
โโ reliability.ts
โ  โโ monitoring.ts
โ  โโ admin (Firestore)
โ
โโ heartbeat.ts
โ
โโ claude.ts
โ  โโ axios (HTTP)
โ  โโ admin (config)
โ
โโ monitoring.ts
   โโ admin (Firestore)
   โโ Sentry
   โโ axios (optional)

Frontend
โโ analyzeUserData endpoint
โโ healthCheck endpoint
โโ getHealthMetrics endpoint
```

---

## ๐ Deployment Architecture

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ      Google Cloud Platform (GCP)           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                            โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โ  Cloud Functions                      โ โ
โ  โ  โโ analyzeUserData (60s timeout)    โ โ
โ  โ  โโ healthCheck (monitoring)         โ โ
โ  โ  โโ getHealthMetrics (API)           โ โ
โ  โ  โโ Max instances: 10                โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ                 โ                          โ
โ                 โผ                          โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โ  Firestore Database                   โ โ
โ  โ  โโ users/{uid}/analysis/            โ โ
โ  โ  โโ ai_analysis_cache/               โ โ
โ  โ  โโ api_events/{date}/events/        โ โ
โ  โ  โโ system/api_metrics               โ โ
โ  โ  โโ users_web_onbording/             โ โ
โ  โ  โโ payments/                        โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ                 โ                          โ
โ    โโโโโโโโโโโโโโผโโโโโโโโโโโโโ             โ
โ    โผ            โผ            โผ             โ
โ  Cloud      Sentry       Cloud            โ
โ  Storage    (Alerts)     Scheduler        โ
โ                          (every 10min)    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
         โ
         โ Calls:
         โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
         โผ                                 โผ
    โโโโโโโโโโโโโโโ               โโโโโโโโโโโโโโโโ
    โ Gemini API  โ               โ Claude API   โ
    โ 45s timeout โ               โ 45s timeout  โ
    โ 4 retries   โ               โ Fallback     โ
    โโโโโโโโโโโโโโโ               โโโโโโโโโโโโโโโโ
```

---

## ๐พ Cache Key Generation Algorithm

```
Input: User Answers
{
  Age: 28,
  Gender: 2 (female),
  SkinType: "oily",
  SkinProblems: [{id: "acne", isActive: true}, ...],
  HairProblems: [{id: "dryness", isActive: true}],
  Stress: "high",
  Mood: "neutral"
}
  โ
  โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ Process Each Field              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ 1. Age:                         โ
โ    28 โ "20-30"                 โ
โ    (age range)                  โ
โ                                 โ
โ 2. Gender:                      โ
โ    2 โ "female"                 โ
โ    (normalized)                 โ
โ                                 โ
โ 3. SkinType:                    โ
โ    "oily" โ "oily"              โ
โ    (as-is)                      โ
โ                                 โ
โ 4. Top Skin Problems (max 3):   โ
โ    [acne, oily, ...] โ sorted   โ
โ    "acne,oily,pore"             โ
โ                                 โ
โ 5. Top Hair Problems (max 2):   โ
โ    [dryness, ...] โ sorted      โ
โ    "dryness"                    โ
โ                                 โ
โ 6. Stress:                      โ
โ    "high" โ "high"              โ
โ                                 โ
โ 7. Mood:                        โ
โ    "neutral" โ "neutral"        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  โ
  โผ
Concatenate: "20-30:female:oily:acne,oily:dryness:high:neutral"
  โ
  โผ
Base64 Encode: "MjAtMzA6ZmVtYWxlOm9pbHk6YWNuZSxvaWx5OmRyeW5lc3M6aGlnaDpuZXV0cmFs"
  โ
  โผ
Use as Firestore Document ID:
/ai_analysis_cache/MjAtMzA6ZmVtYWxlOm9pbHk6YWNuZSxvaWx5OmRyeW5lc3M6aGlnaDpuZXV0cmFs
  โ
  โผ
Cache HIT Rate: ~35-40%
```

---

## ๐ Performance Targets

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ   Latency Breakdown (Target: 15s)  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                    โ
โ Pre-check & validation:   500ms    โ
โ Cache lookup:             200ms    โ
โ Gemini API call:        10,000ms   โ โ Main time
โ JSON parsing:             500ms    โ
โ Validation:               300ms    โ
โ Firestore save:           500ms    โ
โ Cache save:               300ms    โ
โ Event logging:            200ms    โ
โ Total:                  12,500ms   โ
โ                                    โ
โ With cache hit:           300ms    โ
โ With 2nd attempt:       8,000ms    โ
โ With Claude fallback:   18,000ms   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ   Success Rate Improvements         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                    โ
โ No retries:              92%       โ
โ + Retries (4x):          96%       โ
โ + Cache:                 97%       โ
โ + Circuit breaker:       97.5%     โ
โ + Claude fallback:       98-99%    โ
โ                                    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

This architecture ensures:
- โ **High reliability**: 4 retries + circuit breaker + fallback
- โ **Fast responses**: Caching + optimized pre-checks
- โ **Self-healing**: Auto-recovery + graceful degradation
- โ **Observable**: Comprehensive metrics + Sentry alerts
- โ **Scalable**: Stateless functions + partitioned Firestore collections
