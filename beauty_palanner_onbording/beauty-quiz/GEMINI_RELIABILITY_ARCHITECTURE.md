# ğŸ—ï¸ Gemini Reliability - System Architecture

---

## ğŸ“Š High-Level Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     FRONTEND (React/Next.js)                â”‚
â”‚                                                              â”‚
â”‚  POST /analyzeUserData â†’ { userId, answers, photoUrls }    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              CLOUD FUNCTION: analyzeUserData                 â”‚
â”‚                      (Timeout: 60s)                         â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ PHASE 1: PRE-CHECK (5s)                                 â”‚â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚
â”‚  â”‚ âœ“ Circuit breaker check                                 â”‚â”‚
â”‚  â”‚ âœ“ Rate limiting (10 req/min per IP)                    â”‚â”‚
â”‚  â”‚ âœ“ Input validation (age, height, weight)               â”‚â”‚
â”‚  â”‚ âœ“ Cache key generation                                  â”‚â”‚
â”‚  â”‚ âœ“ Check Firestore cache                                â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                             â–¼                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ PHASE 2: AI ANALYSIS (45s max)                          â”‚â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚â”‚
â”‚  â”‚ â”‚ TRY 1: Gemini API                                    â”‚â”‚â”‚
â”‚  â”‚ â”‚ â”œâ”€ Attempt 1: Retry (500ms delay)                   â”‚â”‚â”‚
â”‚  â”‚ â”‚ â”œâ”€ Attempt 2: Retry (1s delay)                      â”‚â”‚â”‚
â”‚  â”‚ â”‚ â”œâ”€ Attempt 3: Retry (2s delay)                      â”‚â”‚â”‚
â”‚  â”‚ â”‚ â””â”€ Attempt 4: Retry (4s delay)                      â”‚â”‚â”‚
â”‚  â”‚ â”‚ âœ— All failed                                         â”‚â”‚â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚â”‚
â”‚  â”‚                      â–¼                                   â”‚â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚â”‚
â”‚  â”‚ â”‚ TRY 2: Claude API Fallback (if enabled)              â”‚â”‚â”‚
â”‚  â”‚ â”‚ âœ“ Claude 3.5 Sonnet                                 â”‚â”‚â”‚
â”‚  â”‚ â”‚ âœ“ Same format as Gemini output                       â”‚â”‚â”‚
â”‚  â”‚ â”‚ âœ— Failed or not enabled                              â”‚â”‚â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚â”‚
â”‚  â”‚                      â–¼                                   â”‚â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚â”‚
â”‚  â”‚ â”‚ FALLBACK: Error Response (graceful failure)          â”‚â”‚â”‚
â”‚  â”‚ â”‚ Status 502: "Service temporarily unavailable"        â”‚â”‚â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                             â–¼                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ PHASE 3: POST-PROCESSING (10s)                          â”‚â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚
â”‚  â”‚ âœ“ Build complete analysis                              â”‚â”‚
â”‚  â”‚ âœ“ Save to Firestore (users/{userId}/analysis)         â”‚â”‚
â”‚  â”‚ âœ“ Save to cache (ai_analysis_cache)                    â”‚â”‚
â”‚  â”‚ âœ“ Log session events                                    â”‚â”‚
â”‚  â”‚ âœ“ Record metrics                                        â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                             â–¼                                â”‚
â”‚  Response: 200 OK { analysis, fromCache?, usedFallback? }   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            MONITORING & ANALYTICS (Background)              â”‚
â”‚                                                              â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ logAPIEvent()                                          â”‚ â”‚
â”‚ â”‚ â†’ Firestore: api_events/{date}/events                â”‚ â”‚
â”‚ â”‚ â†’ Events: success, failure, retry, cache_hit, etc    â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                              â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ updateRealtimeMetrics()                                â”‚ â”‚
â”‚ â”‚ â†’ Firestore: system/api_metrics                        â”‚ â”‚
â”‚ â”‚ â†’ Fields: events, window, avgLatency, etc              â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                              â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ sendSentryAlert()                                      â”‚ â”‚
â”‚ â”‚ â†’ Sentry: Issue/Alerts dashboard                      â”‚ â”‚
â”‚ â”‚ â†’ Alerts: retry_exhausted, circuit_open, etc          â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Request Flow Diagram

```
START
  â†“
[Circuit Breaker?] â”€â”€YESâ†’ Return 503 â”€â”€â†’ END (Error)
  â†“
 NO
  â†“
[Rate Limited?] â”€â”€YESâ†’ Return 429 â”€â”€â†’ END (Error)
  â†“
 NO
  â†“
[Input Valid?] â”€â”€NOâ†’ Return 400 â”€â”€â†’ END (Error)
  â†“
YES
  â†“
[Cache Key Gen] â†’ Calculate similarity hash
  â†“
[Check Cache] â”€â”€HITâ†’ Return Cached Result â”€â”€â†’ END (200 OK)
  â†“
 MISS
  â†“
[Start Heartbeat] â†’ Log progress every 15s
  â†“
[Try Gemini] â”€â”€â”€â”
      â”‚         â”‚
      â”œâ”€â†’ Attempt 1 (500ms)
      â”œâ”€â†’ Attempt 2 (1s)
      â”œâ”€â†’ Attempt 3 (2s)
      â”œâ”€â†’ Attempt 4 (4s)
      â”‚
      â”œâ”€â”€SUCCESSâ†’ Parse JSON â”€â†’ Validate Format â”€â”€YESâ†’ [Save & Return]
      â”‚                                           â”‚
      â”‚                                           NOâ†“
      â”‚                                        [Try Claude]
      â””â”€â”€FAILâ†’ [Try Claude Fallback] â”€â”€SUCCESSâ†’ [Save & Return]
               â”‚                       FAILâ†“
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ Return 502 â”€â”€â†’ END (Error)

[Save & Return]
  â†“
[Save to Firestore]
[Save to Cache]
[Log Session]
[Stop Heartbeat]
[Record Metrics]
[Send Success Event]
  â†“
Return 200 OK + Analysis
  â†“
END
```

---

## ğŸ›ï¸ Data Flow Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   FRONTEND       â”‚
â”‚  (React/Next)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ POST /analyzeUserData
         â”‚ { userId, answers, photos }
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    CLOUD FUNCTION: analyzeUserData       â”‚
â”‚  (Timeout: 60s, Max instances: 10)      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Circuit Breaker Check            â”‚   â”‚
â”‚  â”‚ (in-memory + Firestore)          â”‚   â”‚
â”‚  â”‚ State: { failures, isOpen, ... } â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                 â–¼                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Input Validation                 â”‚   â”‚
â”‚  â”‚ (age, height, weight, etc)       â”‚   â”‚
â”‚  â”‚ âœ“ Trim strings                   â”‚   â”‚
â”‚  â”‚ âœ“ Validate ranges               â”‚   â”‚
â”‚  â”‚ âœ“ Limit array sizes             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                 â–¼                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Cache Key Generation             â”‚   â”‚
â”‚  â”‚ Key = Age:Gender:SkinType:...    â”‚   â”‚
â”‚  â”‚ (Base64 encoded)                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                 â–¼                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Firestore: ai_analysis_cache     â”‚   â”‚
â”‚  â”‚ Check for existing analysis      â”‚   â”‚
â”‚  â”‚ Cache HIT? â†’ Return cached       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                 â–¼                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Retry with Exponential Backoff   â”‚   â”‚
â”‚  â”‚ retryWithBackoff(4 attempts)     â”‚   â”‚
â”‚  â”‚ â”œâ”€ 500ms                         â”‚   â”‚
â”‚  â”‚ â”œâ”€ 1s                            â”‚   â”‚
â”‚  â”‚ â”œâ”€ 2s                            â”‚   â”‚
â”‚  â”‚ â””â”€ 4s                            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                 â–¼                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Gemini API Call (45s timeout)    â”‚   â”‚
â”‚  â”‚ https://generativelanguage...    â”‚   â”‚
â”‚  â”‚ â”œâ”€ User profile + photos         â”‚   â”‚
â”‚  â”‚ â”œâ”€ Strict JSON schema            â”‚   â”‚
â”‚  â”‚ â””â”€ Procedure ID validation       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                 â”‚                        â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚    â–¼ FAIL (after 4 tries)  â–¼ SUCCESS     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  [Parse JSON]   â”‚
â”‚  â”‚ Claude Fallback     â”‚  [Validate]     â”‚
â”‚  â”‚ (if enabled)        â”‚  [Build Analysis]â”‚
â”‚  â”‚                     â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â”‚ API: Claude 3.5     â”‚         â–¼
â”‚  â”‚ Key: $CLAUDE_KEY    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚ (45s timeout)       â”‚  â”‚ Save Results â”‚
â”‚  â”‚                     â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”‚ SUCCESS? â”€â”€YESâ”€â”€â”¬â”€â”€â”€â”¤  â”‚ Firestore:   â”‚
â”‚  â”‚        â””â”€NOâ”€â”  â”‚   â”‚  â”‚ users/{uid}/ â”‚
â”‚  â”‚            â–¼  â–¼   â”‚  â”‚ analysis/    â”‚
â”‚  â”‚       Return 502   â”‚  â”‚ â”œâ”€ model     â”‚
â”‚  â”‚       Error        â”‚  â”‚ â”œâ”€ timestamp â”‚
â”‚  â”‚                    â”‚  â”‚ â””â”€ usedflag  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚                                 â–¼
â”‚                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          â”‚ Save to Cacheâ”‚
â”‚                          â”‚ Firestore:   â”‚
â”‚                          â”‚ analysis_    â”‚
â”‚                          â”‚ cache/{key}  â”‚
â”‚                          â”‚ â”œâ”€ analysis  â”‚
â”‚                          â”‚ â”œâ”€ createdAt â”‚
â”‚                          â”‚ â””â”€ TTL: 7d   â”‚
â”‚                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚                                 â–¼
â”‚                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          â”‚ Log Events   â”‚
â”‚                          â”‚ Firestore:   â”‚
â”‚                          â”‚ api_events/  â”‚
â”‚                          â”‚ {date}/eventsâ”‚
â”‚                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚                                 â–¼
â”‚                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          â”‚ Send Metrics â”‚
â”‚                          â”‚ system/      â”‚
â”‚                          â”‚ api_metrics  â”‚
â”‚                          â”‚ â”œâ”€ events    â”‚
â”‚                          â”‚ â”œâ”€ latency   â”‚
â”‚                          â”‚ â””â”€ status    â”‚
â”‚                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ 200 OK + Analysis
         â”‚
         â–¼
    FRONTEND
    (Display Results)
```

---

## ğŸ” Circuit Breaker State Machine

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         CIRCUIT CLOSED              â”‚
â”‚ (Normal Operation)                  â”‚
â”‚                                     â”‚
â”‚ - Requests flow normally            â”‚
â”‚ - Track success/failure rate        â”‚
â”‚ - Count: failures/total ratio       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
    Failure Rate > 30% in 5 min?
                 â”‚
              YESâ”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         CIRCUIT OPEN                â”‚
â”‚ (Failure Detected)                  â”‚
â”‚                                     â”‚
â”‚ - Return 503 to all requests        â”‚
â”‚ - Stop calling Gemini API           â”‚
â”‚ - Wait for recovery timeout         â”‚
â”‚ - Record time: lastFailureTime      â”‚
â”‚                                     â”‚
â”‚ Triggers:                           â”‚
â”‚ â”œâ”€ sendSentryAlert('error')        â”‚
â”‚ â”œâ”€ Log: CIRCUIT BREAKER OPENED     â”‚
â”‚ â””â”€ Database: circuitBreakerOpen=T  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
    Wait 2 minutes for recovery
                 â”‚
              YESâ”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      CIRCUIT RECOVERING             â”‚
â”‚ (Attempting to Resume)              â”‚
â”‚                                     â”‚
â”‚ - Start allowing requests again     â”‚
â”‚ - Try 1-2 requests to test API      â”‚
â”‚ - If success: go CLOSED             â”‚
â”‚ - If failure: stay OPEN (restart)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
      Recovery succeeds?
                 â”‚
              YESâ”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         CIRCUIT CLOSED              â”‚
â”‚ (Back to Normal)                    â”‚
â”‚ - Continue normal operation         â”‚
â”‚ - Reset failure counters            â”‚
â”‚ - Log: CIRCUIT BREAKER CLOSED       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š Metrics Collection Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Cloud Function: analyzeUserData    â”‚
â”‚   (Every request)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â”‚ Calls: logAPIEvent()
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Firestore Collection: api_events   â”‚
â”‚   Partitioned by date: /{date}/      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                      â”‚
â”‚ Document structure:                  â”‚
â”‚ {                                    â”‚
â”‚   type: 'success' | 'failure' |...  â”‚
â”‚   userId: 'user123'                 â”‚
â”‚   latencyMs: 12345                  â”‚
â”‚   attemptNumber: 2                  â”‚
â”‚   recordedAt: timestamp             â”‚
â”‚ }                                    â”‚
â”‚                                      â”‚
â”‚ Examples:                            â”‚
â”‚ - { type: 'success', latencyMs: 8234â”‚
â”‚ - { type: 'retry', attemptNumber: 2 â”‚
â”‚ - { type: 'cache_hit', latencyMs:245â”‚
â”‚ - { type: 'claude_fallback' }        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ Aggregated to:
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Firestore Document: system/metrics  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                      â”‚
â”‚ {                                    â”‚
â”‚   events: {                          â”‚
â”‚     total: 1250                      â”‚
â”‚     success: 1220                    â”‚
â”‚     failure: 30                      â”‚
â”‚     retry: 85                        â”‚
â”‚     circuit_open: 0                  â”‚
â”‚     cache_hit: 320                   â”‚
â”‚     cache_miss: 512                  â”‚
â”‚     claude_fallback: 8               â”‚
â”‚   },                                 â”‚
â”‚   window: {                          â”‚
â”‚     success: 45                      â”‚
â”‚     failures: 5                      â”‚
â”‚     timestamp: 1728555600000         â”‚
â”‚   },                                 â”‚
â”‚   avgLatency: 12450                  â”‚
â”‚   circuitBreakerOpen: false          â”‚
â”‚   lastUpdated: timestamp             â”‚
â”‚ }                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ Read by:
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â–¼                â–¼              â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Sentry â”‚      â”‚Dashboard â”‚  â”‚Analytics â”‚
    â”‚Alerts  â”‚      â”‚getMetricsâ”‚  â”‚ Frontend â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”Œ Module Dependencies

```
index.ts
â”œâ”€ reliability.ts
â”‚  â”œâ”€ monitoring.ts
â”‚  â””â”€ admin (Firestore)
â”‚
â”œâ”€ heartbeat.ts
â”‚
â”œâ”€ claude.ts
â”‚  â”œâ”€ axios (HTTP)
â”‚  â””â”€ admin (config)
â”‚
â””â”€ monitoring.ts
   â”œâ”€ admin (Firestore)
   â”œâ”€ Sentry
   â””â”€ axios (optional)

Frontend
â”œâ”€ analyzeUserData endpoint
â”œâ”€ healthCheck endpoint
â””â”€ getHealthMetrics endpoint
```

---

## ğŸš€ Deployment Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Google Cloud Platform (GCP)           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Cloud Functions                      â”‚ â”‚
â”‚  â”‚  â”œâ”€ analyzeUserData (60s timeout)    â”‚ â”‚
â”‚  â”‚  â”œâ”€ healthCheck (monitoring)         â”‚ â”‚
â”‚  â”‚  â”œâ”€ getHealthMetrics (API)           â”‚ â”‚
â”‚  â”‚  â””â”€ Max instances: 10                â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                 â”‚                          â”‚
â”‚                 â–¼                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Firestore Database                   â”‚ â”‚
â”‚  â”‚  â”œâ”€ users/{uid}/analysis/            â”‚ â”‚
â”‚  â”‚  â”œâ”€ ai_analysis_cache/               â”‚ â”‚
â”‚  â”‚  â”œâ”€ api_events/{date}/events/        â”‚ â”‚
â”‚  â”‚  â”œâ”€ system/api_metrics               â”‚ â”‚
â”‚  â”‚  â”œâ”€ users_web_onbording/             â”‚ â”‚
â”‚  â”‚  â””â”€ payments/                        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                 â”‚                          â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚    â–¼            â–¼            â–¼             â”‚
â”‚  Cloud      Sentry       Cloud            â”‚
â”‚  Storage    (Alerts)     Scheduler        â”‚
â”‚                          (every 10min)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ Calls:
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â–¼                                 â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Gemini API  â”‚               â”‚ Claude API   â”‚
    â”‚ 45s timeout â”‚               â”‚ 45s timeout  â”‚
    â”‚ 4 retries   â”‚               â”‚ Fallback     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ’¾ Cache Key Generation Algorithm

```
Input: User Answers
{
  Age: 28,
  Gender: 2 (female),
  SkinType: "oily",
  SkinProblems: [{id: "acne", isActive: true}, ...],
  HairProblems: [{id: "dryness", isActive: true}],
  Stress: "high",
  Mood: "neutral"
}
  â”‚
  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Process Each Field              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. Age:                         â”‚
â”‚    28 â†’ "20-30"                 â”‚
â”‚    (age range)                  â”‚
â”‚                                 â”‚
â”‚ 2. Gender:                      â”‚
â”‚    2 â†’ "female"                 â”‚
â”‚    (normalized)                 â”‚
â”‚                                 â”‚
â”‚ 3. SkinType:                    â”‚
â”‚    "oily" â†’ "oily"              â”‚
â”‚    (as-is)                      â”‚
â”‚                                 â”‚
â”‚ 4. Top Skin Problems (max 3):   â”‚
â”‚    [acne, oily, ...] â†’ sorted   â”‚
â”‚    "acne,oily,pore"             â”‚
â”‚                                 â”‚
â”‚ 5. Top Hair Problems (max 2):   â”‚
â”‚    [dryness, ...] â†’ sorted      â”‚
â”‚    "dryness"                    â”‚
â”‚                                 â”‚
â”‚ 6. Stress:                      â”‚
â”‚    "high" â†’ "high"              â”‚
â”‚                                 â”‚
â”‚ 7. Mood:                        â”‚
â”‚    "neutral" â†’ "neutral"        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚
  â–¼
Concatenate: "20-30:female:oily:acne,oily:dryness:high:neutral"
  â”‚
  â–¼
Base64 Encode: "MjAtMzA6ZmVtYWxlOm9pbHk6YWNuZSxvaWx5OmRyeW5lc3M6aGlnaDpuZXV0cmFs"
  â”‚
  â–¼
Use as Firestore Document ID:
/ai_analysis_cache/MjAtMzA6ZmVtYWxlOm9pbHk6YWNuZSxvaWx5OmRyeW5lc3M6aGlnaDpuZXV0cmFs
  â”‚
  â–¼
Cache HIT Rate: ~35-40%
```

---

## ğŸ“ˆ Performance Targets

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Latency Breakdown (Target: 15s)  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                    â”‚
â”‚ Pre-check & validation:   500ms    â”‚
â”‚ Cache lookup:             200ms    â”‚
â”‚ Gemini API call:        10,000ms   â”‚ â† Main time
â”‚ JSON parsing:             500ms    â”‚
â”‚ Validation:               300ms    â”‚
â”‚ Firestore save:           500ms    â”‚
â”‚ Cache save:               300ms    â”‚
â”‚ Event logging:            200ms    â”‚
â”‚ Total:                  12,500ms   â”‚
â”‚                                    â”‚
â”‚ With cache hit:           300ms    â”‚
â”‚ With 2nd attempt:       8,000ms    â”‚
â”‚ With Claude fallback:   18,000ms   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Success Rate Improvements         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                    â”‚
â”‚ No retries:              92%       â”‚
â”‚ + Retries (4x):          96%       â”‚
â”‚ + Cache:                 97%       â”‚
â”‚ + Circuit breaker:       97.5%     â”‚
â”‚ + Claude fallback:       98-99%    â”‚
â”‚                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

This architecture ensures:
- âœ… **High reliability**: 4 retries + circuit breaker + fallback
- âœ… **Fast responses**: Caching + optimized pre-checks
- âœ… **Self-healing**: Auto-recovery + graceful degradation
- âœ… **Observable**: Comprehensive metrics + Sentry alerts
- âœ… **Scalable**: Stateless functions + partitioned Firestore collections
